<!doctype html>
<html class="no-js" lang="en">
	<head>
		<title>Garage</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
	</head>
	<body>
		<div id="app">
			<h1>State</h1>
			<p>{{ stateText }}</p>

			<h2>Timers</h2>
			<p v-if="timers.lenght <= 0">No running timers.</p>
			<ul v-else>
				<li v-for="t in timers">
					<countdown :time="t.triggerTime - new Date">
						<template slot-scope="props">
							{{ props.minutes }} minutes, {{ props.seconds }} seconds.
						</template>
					</countdown>
					<button @click="cancelTimer(t.id)">Cancel</button>
				</li>
			</ul>

			<h1>Update</h1>
			<form @submit.prevent="submit">
				<input type="number" min="0" max="30" placeholder="minutes" v-model="form.minutes" />
				<input type="password" placeholder="password" v-model="form.password" />
				<button type="submit">Toggle</button>

				<p v-if="lastError" style="{ color: red; }">{{ lastError }}</p>
			</form>

			<p>{{ connected ? 'connected' : 'disconnected' }}</p>
		</div>

		<script src="/socket.io/socket.io.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
		<!--<script src="https://cdn.jsdelivr.net/npm/vue"></script>-->
		<script src="vue-countdown.min.js"></script>
		<script>
			Vue.component(VueCountdown.name, VueCountdown);

			var app = new Vue({
				el: '#app',
				data: {
					socket: null,
					timers: [],
					isOpen: false,
					lastError: '',
					form: {
						minutes: undefined,
						password: ''
					}
				},
				created: function() {
					this.socket = io();

					var that = this;

					//socket.io hooks
					this.socket.on('input-error', function(msg){
						that.lastError = msg;
					});
					this.socket.on('gateState', function(state) {
						that.isOpen = (state == 'open');
					});
					this.socket.on('timers', function(timers) {
						that.timers = timers;
					});
				},
				computed: {
					stateText: function() {
						return this.isOpen ? 'Open' : 'Closed';
					},
					connected: function() {
						return this.socket.connected;
					}
				},
				methods: {
					submit: function() {
						let data = {
							code: this.form.password,
							seconds: this.form.minutes * 60,
						}
						this.lastError = '';
						this.socket.emit('gateToggle', data);

						this.form.minutes = undefined;
						this.form.password = '';
					},
					cancelTimer: function(timerId) {
						this.lastError = '';
						this.socket.emit('cancelTimer', timerId);
					}
				}
			});
		</script>
	</body>
</html>
