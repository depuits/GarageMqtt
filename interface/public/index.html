<!doctype html>
<html class="no-js" lang="en">
	<head>
		<base href="/" />
		<title>Garage</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link href="https://fonts.googleapis.com/css?family=Press+Start+2P" rel="stylesheet">
		<link href="https://unpkg.com/nes.css@2.2.1/css/nes.min.css" rel="stylesheet" />
		<link href="style.css" rel="stylesheet" />
	</head>
	<body>
		<div id="app">
			<div class="container">
				<section class="topic">
					<div class="nes-container with-title">
						<h3 class="title">State</h3>
						<p>{{ stateText }}</p>
					</div>
				</section>
			
				<section class="topic">
					<div class="nes-container with-title">
						<h3 class="title">Update</h3>
						<form @submit.prevent="submit" class="item">
							<div class="nes-field">
								<label for="minutes">Minutes</label>
								<input type="text" id="minutes" class="nes-input" type="number" min="0" max="30" placeholder="minutes" v-model="form.minutes" />
							</div>
							
							<div class="nes-field">
								<label for="password">Password</label>
								<input type="text" id="password" class="nes-input" type="password" placeholder="password" v-model="form.password" />
							</div>

							<button type="submit" class="nes-btn">Toggle</button>

							<span class="nes-text is-error" v-if="lastError">{{ lastError }}</span>
						</form>
					</div>
				</section>

				<section class="topic">
					<div class="nes-container with-title">
						<h3 class="title">Timers</h3>
						<p v-if="timers.length <= 0">No running timers.</p>
						<ul v-else  class="item">
							<li v-for="t in timers">
								<countdown :time="t.triggerTime - new Date">
									<template slot-scope="props">
										{{ props.minutes }} minutes, {{ props.seconds }} seconds.
									</template>
								</countdown>
								<button @click="cancelTimer(t.id)" class="nes-btn is-error">Cancel</button>
							</li>
						</ul>
					</div>
				</section>

				<p>{{ connected ? 'connected' : 'disconnected' }}</p>
			</div>
		</div>

		<script src="/socket.io/socket.io.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
		<!--<script src="https://cdn.jsdelivr.net/npm/vue"></script>-->
		<script src="vue-countdown.min.js"></script>
		<script>
			Vue.component(VueCountdown.name, VueCountdown);

			var app = new Vue({
				el: '#app',
				data: {
					socket: null,
					timers: [],
					isOpen: false,
					lastError: '',
					form: {
						minutes: undefined,
						password: ''
					}
				},
				created: function() {
					// consider the base path for when the app is behind a reverse proxy and urls are rewritten
					let baseHref = (document.getElementsByTagName('base')[0] || {}).getAttribute('href') || '';
					if (baseHref.endsWith('/')) {
						baseHref = baseHref.slice(0, -1);
					}

					let socketPath = baseHref + '/socket.io';

					this.socket = io({ path: socketPath });

					var that = this;

					//socket.io hooks
					this.socket.on('input-error', function(msg){
						that.lastError = msg;
					});
					this.socket.on('gateState', function(state) {
						that.isOpen = (state == 'open');
					});
					this.socket.on('timers', function(timers) {
						that.timers = timers;
					});
				},
				computed: {
					stateText: function() {
						return this.isOpen ? 'Open' : 'Closed';
					},
					connected: function() {
						return this.socket.connected;
					}
				},
				methods: {
					submit: function() {
						let data = {
							code: this.form.password,
							seconds: this.form.minutes * 60,
						}
						this.lastError = '';
						this.socket.emit('gateToggle', data);

						this.form.minutes = undefined;
						this.form.password = '';
					},
					cancelTimer: function(timerId) {
						this.lastError = '';
						this.socket.emit('cancelTimer', timerId);
					}
				}
			});
		</script>
	</body>
</html>
